"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const dataManager_1 = require("./dataManager");
class AsyncManager extends dataManager_1.DataManager {
    constructor(load, create) {
        super();
        this._innerLoad = load;
        this._innerCreate = create;
        this._inFlight = {};
    }
    _createAndAddDefault(d) {
        let model = this.create(d);
        this.add(model);
        return this;
    }
    getOrCreate(id) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!id) {
                throw new Error("no ID provided");
            }
            let datum = this.get(id);
            if (datum) {
                return datum;
            }
            if (this._inFlight[id]) {
                return this._inFlight[id];
            }
            this._inFlight[id] = this._loadAndCreate(id);
            return this._inFlight[id];
        });
    }
    _loadAndCreate(id) {
        return __awaiter(this, void 0, void 0, function* () {
            let d = yield this.load(id);
            if (!d) {
                throw new Error("no data found for id '" + id + "'");
            }
            ;
            let model = this.create(d);
            let datum = model;
            this.add(datum);
            return datum;
        });
    }
    create(d) {
        if (this._innerCreate) {
            return this._innerCreate(d);
        }
        else
            return d;
    }
    load(id) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this._innerLoad) {
                Promise.reject('innerLoad not defined');
            }
            return this._innerLoad(id);
        });
    }
}
exports.AsyncManager = AsyncManager;
